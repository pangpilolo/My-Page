# EasyChat模块解析

#### 用户模块
> 用户模块涉及用户的注册、登录、登出、信息修改等功能
>

1. 注册登录使用了`aspectjweaver`组件，生成base64的图片码(算数计算)，同时生成答案。注册和登录都会生成一个唯一id组成一个Key存入Redis中，注册时需要携带Key检查验证码答案是否正确。
2. 用户注册：需要注意的点是用户的密码传输时要加密，邮箱不能重复。<u>ID生成时用户ID以U开头</u>，后续区分的群ID和用户ID。和靓号模块联动，email相同使用靓号ID。用户的申请是否验证默认值，最后密码加密入库。
3. 用户登录：验证码，账户不能被封禁，秘密校验比对。根据用户ID利用JWT生成token，用户ID为Key用户信息为Value存入Redis。同时检验是否是配置文件中设置的管理员用户，设置isAdmin属性。
4. 退出：删除Redis中的用户信息、用户的联系人缓存，删除Netty中的Channel，以及GroupChannel中绑定的用户Channel。
5. 获取用户详细信息：必须是当前登录用户，查询数据库返回信息
6. 修改用户信息：修改的用户信息的ID必须是当前登录用户ID，修改头像需要重新存储用户头像图片，updateById更新其他信息，但是<u>密码不能更新</u>。修改昵称还需要ChatSessionUser表中的冗余昵称字段。同时向所有的好友发送用户昵称修改消息，好友同步更新会话昵称。
7. 修改密码：修改的密码的用户ID必须是当前登录用户ID，将密码解密后，用其他加密算法加密后存入DB，同时强制用户登出。用户重新登录
8. 根据好友用户ID获取好友用户信息，需要验证当前用户是否和此用户存在好友关系，并且把关系状态一起封装返回。

#### 关系模块
表设计重点：这个模块设计两张表 申请记录表、用户/群组关系表，申请表要注意的点是，如果是加群申请，那么接受这个申请记录的用户id就是这个群的群主。

业务重点：关系模块重要的功能就是用户和群组之间建立关系，熟悉微信就知道，一般添加群或者用户都需要发起申请，等一系列流程，所以具体功能：根据ID搜索、发起加群/好友申请、分页查看自己收到的申请、处理申请、查询联系人（好友列表和群列表）、删除好友/拉黑好友



这个模块最重要的功能就是，用户/群组之间的联系，是这个应用的核心。因为聊天软件就是社交软件的一种，最重要的还是社交属性，那么社交就会设计到个体与个体之间的关系，以及个体与群体之间的关系。个体是否能向另一个个体发消息，建立关系，以及个体向群体建立关系等这些就是关系模块的作用。

同时和关系模块比较耦合的一个模块就是<u>消息发送模块</u>，因为关系建立会涉及到通信，所以需要及时的更新通信channel的绑定，比如个体和群体建立关系就非常需要这个一点，要讲一个用户加入到群聊的Channel中去。

#### 群组模块
> 群模块主要就是将个体与多个个体组成一个集体，一起交流
>

这个模块因为退群、踢群、拉人、解散群等业务功能和消息分布式发送有了耦合，因为分布式的缘故，一个群聊可能在多个主机上都存在一部分用户channel和群聊绑定，所以需要在各个主机收到消息后进行分发时判断消息类型，去对本机的groupChannel操做

同时由于联系人缓存的关系，需要在退群和踢群，拉人业务中及时更新对应用户的联系人列表

创建群的时候，还需要注意设置的用户群聊创建最大数量，以及拉人时群聊的最大人数

#### 后台管理模块
后台管理主要是增删改查用户，靓号，群组，系统参数配置等信息。

#### 应用版本管理
> 版本管理设计客户端的更新
>

应用版本管理涉及的点：版本号管理，版本修改时的各种校验，发布状态，新版本的补丁包下载分流

+ 发布状态：灰度发布与全网发布为中心。灰度发布时，可以设置哪些用户ID可以参与更新，同时用户在查询是否有新版本时，就要区分全网发布和灰度发布的业务概念了。全网发布代表所有人都可以下载，而灰度发布只允许配置了的用户才能更新。
+ 版本号管理：版本号如 1.0.1，那么发布版本1.0.0就不可以，因为不允许发布比最新版本更小的版本，那如何校验版本号之间的大小的呢？首先版本号必须符合规范，可以将版本号字符串的点去除，转为数字再去比较，如果途中报错说明版本号不符合规范。同时数据库中也可以根据字符串的字典序去比较和排序。
+ <u>版本补丁的分流下载</u>：主要是因为补丁包可能比较大，那么就会占用服务器的带宽和IO，所以可以将补丁包部署到多个对象存储主机上，等待用户获取，由于会涉及多个对象存储主机，那么就会有地址选择时的**负载均衡**

#### Netty部分
Netty主要是为了维护用户的cahnnel和群组channel，以及心跳维护及时剔除离线用户的channel。其中涉及：读空闲、写空闲导致的心跳。多个Hannler去加工处理数据、WebSocket的了解管理，以及断开连接后去调用用户登出的借口去清空用户在线状态等。

#### 消息发送模块
消息发送的设计重点在于，如何设计的可扩展。对于这个问题，相对简单的解决办法就是传输的消息对象中留出一个泛型对象随时存储额外的信息。同时为了标志不同的消息，还需要消息类型属性。



如果是文件类型消息，为了优化微信等聊天，当客户端发送文件时，会先向服务器发送一个文件发送的消息，好友或者是群聊中的好友在即使文件没有完全上传时，在页面中观察到对方即将发送文件，这样是满足即时通讯的业务需求的，当用户发送此消息后才将文件上传至服务器，同时进行一些文件上传校验，并且文件上传成功会再发送文件已上传的消息，这样客户端就会主动拉取文件等待用户下载。

文件下载时需要注意的一点是，严格校验当前进行文件下载的用户是否是能够获取该文件的用户，比如是否在对应的群聊中，且是好友状态，或者是否是好友联系人发送给当前用户的。



消息发送还有一个设计重点在于分布式下，如何向不在同一个服务器的联系人或者群组发送消息，这里利用了Redis的Pub/Sub，主动发送消息的主机发布消息，其他主机收到后再向自己的内容发送消息

